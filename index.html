<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body {
    font: 10px sans-serif;
    margin: auto;
    position: relative;
    width: 960px;
  }

  text {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .bar {
    fill: steelblue;
  }

  .w-group {
    fill: none;
    stroke-width: 1px;
    stroke: blue;
  }

  form {
    position: absolute;
    right: 10px;
    top: 10px;
  }
</style>
  <input type="number" id="length-input" onkeyup="updateLength()" onmousedown="updateLength()" onmouseup="updateLength()" max="1000">
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

var DEFAULT_Fy = 50; // ksi
var DEFAULT_E = 29000; // ksi
var DEFAULT_Cb = 1; //
var MAX_UNBRACED = 140; // ft
var UNBRACED_STEP = 1; // ft

var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = window.innerHeight - margin.top - margin.bottom - 10;

var x0 = d3.scale.linear()
    .range([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x0)
    .orient('bottom');

var yAxis = d3.svg.axis()
    .scale(y)
    .orient('left');
    // .tickFormat(d3.format('.2s'));

var line = d3.svg.line()
    .x(function(d){ return x0(d.length);})
    .y(function(d){ return y(d.Mn);});

var svg = d3.select('body').append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
  .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

var W_BEAMS = [];
d3.csv('data.csv', function(error, data) {
  if (error) throw error;

  var beams = d3.nest()
    .key(function(d){ return d.AISC_Manual_Label.split('X')[0]; })
    .entries(data)

  W_BEAMS = beams.filter(getWSections);
  W_BEAMS.forEach(calculateProperties);

  // countType = d3.keys(data[0]).filter(function(key) { return key !== 'Engineer'; });
  // data.forEach(function(d) {
  //   d.counts = countType.map(function(name) { return {name: name, value: +d[name]}; });
  // })
  // globalData = data.slice();
  // data = data.sort(function(a, b){
  //   return +b[sortType] - +a[sortType];
  // })

  x0.domain([0, MAX_UNBRACED]);
  y.domain([0, 13000]);

  svg.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + height + ')')
      .call(xAxis)
    .append('text')
      .attr('x', width)
      .style('text-anchor', 'end')
      .text('Unbraced Length');

  svg.append('g')
      .attr('class', 'y axis')
      .call(yAxis)
    .append('text')
      .attr('transform', 'rotate(-90)')
      .attr('y', 6)
      .attr('dy', '.71em')
      .style('text-anchor', 'end')
      .text('Available Moment (k-ft) - No Phi applied yet');

  var engineer = svg.selectAll('.w-group')
      .data(W_BEAMS)
    .enter().append('g')
      .attr('class', function(d){ return 'g w-group ' + d.key;})
      .attr('stroke-width', function(d, i){
        if (i === Math.round(Math.random()*W_BEAMS.length)){ return 3; }
        return 1;
      })
      .attr('opacity', function(d, i){
        if (i === Math.round(Math.random()*W_BEAMS.length)){ return 1; }
        return 0.10;
      })

  engineer.selectAll('path')
      .data(function(d) { return d.values; })
    .enter().append('path')
      .attr('d', function(d){ return line(d.MnValues); });
});

function updateLength() {
  newLength = +document.getElementById('length-input').value;
  startLength = Math.max(0, newLength - 5);
  endLength = (newLength === 0) ? MAX_UNBRACED : Math.min(MAX_UNBRACED, newLength + 5);

  x0.domain([startLength, endLength]);
  d3.selectAll('.x.axis')
    .transition().duration(2000)
    .call(xAxis);

  line = d3.svg.line()
    .x(function(d){ return x0(d.length);})
    .y(function(d){ return y(d.Mn);});

  var engineer = d3.selectAll('.w-group')
      .data(W_BEAMS)

  engineer.selectAll('path')
      .data(function(d) { return d.values; })
      .transition().duration(2000)
      .attr('d', function(d){ return line(d.MnValues); });

}

function getWSections (data){
  return (data.key.slice(0,1) === 'W') && (data.key.slice(0,2) !== 'WT');
}

function calculateProperties (beamGroup){
  beamGroup.values.forEach(function(bm){
    bm.Mp = DEFAULT_Fy * +bm.Zx; // kip-in
    bm.Lp = 1.76 * +bm.ry * Math.sqrt(DEFAULT_E / DEFAULT_Fy) / 12; // ft. [AISC 16.1-48 (F2-5)]
    var c = 1;                                                 // [AISC 16.1-48 (F2-8a)]
    bm.Lr = 1.95 * +bm.rts * (DEFAULT_E / (0.7 * DEFAULT_Fy))  // ft. [AISC 16.1-48 (F2-6)]
                  * Math.sqrt(+bm.J * c / (+bm.Sx * +bm.ho))
                  * Math.sqrt(1 + Math.sqrt(1 + 6.76 * Math.pow(
                    0.7 * DEFAULT_Fy * +bm.Sx * +bm.ho / (DEFAULT_E * +bm.J * c)
                  , 2))) / 12;
    // Returns Mn
    // Lb expected in feet
    bm.MnFunction = function(Lb){
      if (Lb <= bm.Lp){
        return bm.Mp;
      } else if (bm.Lp < Lb && Lb <= bm.Lr){
        return Math.min(bm.Mp,
          DEFAULT_Cb * (bm.Mp - (bm.Mp - 0.7 * DEFAULT_Fy * +bm.Sx) * (Lb - bm.Lp)/(bm.Lr - bm.Lp))
        );
      } else {
      var Fcr = (DEFAULT_Cb * Math.pow(Math.PI, 2) * DEFAULT_E / Math.pow(Lb*12/+bm.rts, 2)) // kip-in. [AISC 16.1-47 (F2-4)]
                * Math.sqrt(1 + 0.078 * +bm.J * c / (+bm.Sx * +bm.ho) * Math.pow(Lb*12/+bm.rts, 2));
        return Math.min(bm.Mp, Fcr * +bm.Sx);
      }
    }
    bm.MnValues = d3.range(0, MAX_UNBRACED, UNBRACED_STEP).map(function(length){
      return { length: length, Mn: bm.MnFunction(length)/12 }
    })


  })
}
</script>
